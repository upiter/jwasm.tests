JWasm v2.19, Oct 21 2025
test.pe.imports.ref.asm
                                ; test.pe.imports.ref.asm

                                ; Import data reference

                                ; Build:
                                ; jwasm -pe test.pe.imports.ref.asm
                                ; make


                                title	pe_imports

                                .errndef	__JWASM__, "JWasm compatible assembler required!"


                                ; Options

 = 1                            PE_IMP_REF	equ	1
                                ; DIRECT_IMPORTS	equ	1
                                ; DIRECT_IMPORTS_FIX	equ	1


                                .x64
                                .model	flat, fastcall
00000000                    *   _TEXT segment PARA FLAT PUBLIC 'CODE'
00000000                    *   _TEXT ends
00000000                    *   _DATA segment PARA FLAT PUBLIC 'DATA'
00000000                    *   _DATA ends
                            *   assume cs:flat,ds:flat,ss:flat,es:flat,fs:ERROR,gs:NOTHING
                                option	casemap:none

                                option	procalign:16

                                option	frame:auto
                                option	win64:3


                                ; Types
                                include		defs.inc
                              C ; defs.inc
                              C 
                              C ; Types
                              C 
                              C UINT		typedef	DWORD
                              C PSTR		typedef	ptr
                              C PCSTR		typedef	ptr
                              C PCWSTR		typedef	ptr
                              C HINSTANCE	typedef	QWORD
 = 0                          C NULL		equ	0
                              C 
 = export FRAME               C EFRAME		textequ	<export FRAME>


                                ; Imports
                                ; ifdef	DIRECT_IMPORTS
                                include		imports.inc
                              C ; imports.inc
                              C 
                              C dllimp	macro	dllname
 >                            C 
 >                            C 	ifdef	DIRECT_IMPORTS
 >                            C 
 >                            C 	ifb	<dllname>
 >                            C 		option	dllimport:none
 >                            C 	else
 >                            C 		option	dllimport:<dllname>
 >                            C 	endif
 >                            C 
 >                            C 	endif	; DIRECT_IMPORTS
 >                            C 
 >                            C endm
                              C 
                              C 
                              C ; Imports
                              C 
                              C dllimp	kernel32.dll
                             1C 
                             1C 
                             1C 		option	dllimport:<kernel32.dll>
                             1C 
                             1C 
                              C 
                              C GetModuleHandleA	proto	lpModuleName:PCSTR
 = GetModuleHandleA           C GetModuleHandle		textequ	<GetModuleHandleA>
                              C 
                              C GetCommandLineA		proto
 = GetCommandLineA            C GetCommandLine		textequ	<GetCommandLineA>
                              C 
                              C GetStartupInfoA		proto	lpStartupInfo:ptr
                              C GetStartupInfoW		proto	lpStartupInfo:ptr
 = GetStartupInfoA            C GetStartupInfo		textequ	<GetStartupInfoA>
                              C 
                              C OutputDebugStringA	proto	lpOutputString:PCSTR
                              C OutputDebugStringW	proto	lpOutputString:PCWSTR
 = OutputDebugStringA         C OutputDebugString	textequ	<OutputDebugStringA>
                              C 
                              C ExitProcess		proto	uExitCode:UINT
                              C 
                              C 
                              C dllimp	msvcrt.dll
                             1C 
                             1C 
                             1C 		option	dllimport:<msvcrt.dll>
                             1C 
                             1C 
                              C 
                              C __getmainargs		proto	argc:ptr, argv:ptr, env:ptr, doWildCard:dword, startInfo:ptr
 = __getmainargs              C getmainargs		textequ	<__getmainargs>
                              C 
                              C printf			proto	format:ptr byte, :vararg
                              C sprintf			proto	buffer:ptr byte, format:ptr byte, :vararg
                              C 
                              C 
                              C dllimp	; required, dllimport terminator
                             1C 
                             1C 
                             1C 		option	dllimport:none
                             1C 
                             1C 
                                ; else
                                ; include	kernel32.inc
                                ; include	msvcrt.inc

                                ; ifndef	DIRECT_IMPORTS
                                includelib	kernel32.lib
                                includelib	msvcrt.lib
                                ; endif


                                ; OutputDebugString
                                fn_OutputDebugString	typedef	proto	msg:ptr
                                pfn_OutputDebugString	typedef ptr	fn_OutputDebugString

00000000                        DBG_API	struct
00000000                        	OutputDebugStringA	pfn_OutputDebugString	?
00000008                        	OutputDebugStringW	pfn_OutputDebugString	?
00000010                        DBG_API	ends


                                .data
00000000                    *   _DATA segment
                            *   assume cs:ERROR

00000000 496D706F7274207265     AppName			db	"Import reference", 0
00000011 416464726573732040     szFmt			db	"Address @ %p", 0

                                Public	AsmVersion
0000001E DB000000               AsmVersion		dd	__JWASM__	; VER_MAJOR * 100 + VER_MINOR
00000022 4A5761736D20766572     szAsmVerFmt		db	"JWasm version: %d.%d (%d)", 0

0000003C 00000000               align	10h

                                ; Testing direct import reference
                                Public	DbgApi

                                ifdef	DIRECT_IMPORTS_FIX

                                externdef	__imp_OutputDebugStringA: ptr proc
                                externdef	__imp_OutputDebugStringW: ptr proc

00000040 000000000000000000     DbgApi			DBG_API	<__imp_OutputDebugStringA, __imp_OutputDebugStringW>

                                endif	; DIRECT_IMPORTS_FIX

00000050                        align	10h

                                ; Direct import address
                                ; pOutputDebugStringA	dq	_imp__OutputDebugStringA


                                .data?
00000050                    *   _DATA ends
00000000                    *   _BSS segment PARA FLAT PUBLIC 'BSS'
                            *   assume cs:ERROR

00000000 0000000000000000       hInstance		HINSTANCE	?
00000008 0000000000000000       CommandLine		PSTR		?

00000010                        align	10h
00000010 000000000000000000     strBuffer		db 200h dup (?)


                                .code
00000210                    *   _BSS ends
00000000                    *   _TEXT segment
                            *   assume cs:FLAT

00000000                        print	proc export FRAME	uses rsi msg:ptr

                                	Local	strLf	:QWORD

00000000 48894C2408         *   mov [rsp+8], rcx
00000005 55                 *   push rbp
                            *   .pushreg rbp
00000006 488BEC             *   mov rbp, rsp
                            *   .setframe rbp, 0
00000009 56                 *   push rsi
                            *   .pushreg rsi
0000000A 4883EC28           *   sub rsp, 8 + @ReservedStack
                            *   .allocstack 8 + @ReservedStack
                            *   .endprolog
0000000E 488BF1                 	mov	rsi, rcx
00000011                        	invoke	OutputDebugStringA, rcx
                            *    externdef __imp_OutputDebugStringA: ptr proc
00000011 FF15 00000000r     *    call __imp_OutputDebugStringA
00000017                        	invoke	printf, rsi
00000017 488BCE             *    mov rcx, rsi
                            *    externdef __imp_printf: ptr proc
0000001A FF15 00000000r     *    call __imp_printf

00000020 488D4DF0               	lea	rcx, strLf
00000024 B80A000000             	mov	eax, 0Ah	; LF
00000029 8901                   	mov	[rcx], eax
0000002B                        	invoke	printf, rcx
                            *    externdef __imp_printf: ptr proc
0000002B FF15 00000000r     *    call __imp_printf

                                	ret
00000031 4883C428           *   add rsp, 8 + @ReservedStack
00000035 5E                 *   pop rsi
00000036 5D                 *   pop rbp
00000037 C3                 *   retn 

00000038                    *   .xdata segment align(8) flat read 'DATA'
00000000                    *   $xdatasym label near
00000000 010E0405           *   db 1t + (00h shl 3), 14t, 4t, 05h + (00h shl 4)
00000004 0E420A6009530650   *   dw 0420eh, 0600ah, 05309h, 05006h
0000000C                    *   align 4
0000000C                    *   .xdata ends
00000000                    *   .pdata segment align(4) flat read 'DATA'
00000000 000000003800000000 *   dd imagerel print, imagerel print+038h, imagerel $xdatasym+00h
0000000C                    *   .pdata ends
00000038                        print	endp


 = A3D70A3D                     div100	equ	0A3D70A3Dh

                                Public	asm_ver
00000040                        asm_ver	proc export FRAME	version:DWORD

                                	; mov	ecx, version
00000040 48894C2408         *   mov [rsp+8], rcx
00000045 55                 *   push rbp
                            *   .pushreg rbp
00000046 488BEC             *   mov rbp, rsp
                            *   .setframe rbp, 0
00000049 4883EC30           *   sub rsp, 0 + @ReservedStack
                            *   .allocstack 0 + @ReservedStack
                            *   .endprolog
0000004D 8BC1                   	mov	eax, ecx

                                	; mov
0000004F BA3D0AD7A3             	mov	edx, div100
00000054 FFC0                   	inc	eax
00000056 F7E2                   	mul	edx
00000058 C1EA06                 	shr	edx, 6

0000005B 448BC2                 	mov	r8d, edx	; major version

0000005E 8BC2                   	mov	eax, edx
00000060 BA64000000             	mov	edx, 100
00000065 F7E2                   	mul	edx

00000067 448BC9                 	mov	r9d, ecx
0000006A 442BC8                 	sub	r9d, eax	; minor version

0000006D                        	invoke	sprintf, addr strBuffer, addr szAsmVerFmt, r8d, r9d, ecx
0000006D 894C2420           *    mov [rsp+32], ecx
00000071 488D0D 00000000r   *    lea rcx, strBuffer
00000078 488D15 00000000r   *    lea rdx, szAsmVerFmt
                            *    externdef __imp_sprintf: ptr proc
0000007F FF15 00000000r     *    call __imp_sprintf
00000085 488D05 00000000r       	lea	rax, strBuffer

                                	ret
0000008C 4883C430           *   add rsp, 0 + @ReservedStack
00000090 5D                 *   pop rbp
00000091 C3                 *   retn 

00000092                    *   .xdata segment
0000000C 010D0305           *   db 1t + (00h shl 3), 13t, 3t, 05h + (00h shl 4)
00000010 0D5209530650       *   dw 0320dh, 05309h, 05006h
00000016 0000               *   align 4
00000018                    *   .xdata ends
0000000C                    *   .pdata segment
0000000C 00000000520000000C *   dd imagerel asm_ver, imagerel asm_ver+052h, imagerel $xdatasym+0Ch
00000018                    *   .pdata ends
00000092                        asm_ver	endp


                                public	main
000000A0                        main	proc export FRAME	hInst:HINSTANCE, CmdLine:PSTR

000000A0 48894C2408         *   mov [rsp+8], rcx
000000A5 4889542410         *   mov [rsp+16], rdx
000000AA 55                 *   push rbp
                            *   .pushreg rbp
000000AB 488BEC             *   mov rbp, rsp
                            *   .setframe rbp, 0
000000AE 4883EC20           *   sub rsp, 0 + @ReservedStack
                            *   .allocstack 0 + @ReservedStack
                            *   .endprolog
000000B2                        	invoke	print, addr AppName
000000B2 488D0D 00000000r   *    lea rcx, AppName
000000B9 E842FFFFFF         *    call print

                                	; JWasm assembler version
000000BE                        	invoke	asm_ver, AsmVersion
000000BE 8B0D 00000000r     *    mov ecx, AsmVersion
000000C4 E877FFFFFF         *    call asm_ver
000000C9                        	invoke	print, rax
000000C9 488BC8             *    mov rcx, rax
000000CC E82FFFFFFF         *    call print

000000D1                        	invoke	sprintf, addr strBuffer, addr szFmt, DbgApi.OutputDebugStringA
000000D1 4C8B05 00000000r   *    mov r8, DbgApi.OutputDebugStringA
000000D8 488D0D 00000000r   *    lea rcx, strBuffer
000000DF 488D15 00000000r   *    lea rdx, szFmt
                            *    externdef __imp_sprintf: ptr proc
000000E6 FF15 00000000r     *    call __imp_sprintf
000000EC                        	invoke	print, addr strBuffer
000000EC 488D0D 00000000r   *    lea rcx, strBuffer
000000F3 E808FFFFFF         *    call print

000000F8 488B15 00000000r       	mov	rdx, DbgApi.OutputDebugStringA
000000FF                        	.if	rdx
000000FF 4823D2             *   and rdx, rdx
00000102 7404               *   jz  @C0001
00000104 33C0                   		xor	eax, eax
00000106                        	.else
00000106 EB02               *   jmp @C0002
00000108                    *   @C0001:
00000108 0CFF                   		or	al, -1
0000010A                        	.endif
0000010A                    *   @C0002:

                                	ret
0000010A 4883C420           *   add rsp, 0 + @ReservedStack
0000010E 5D                 *   pop rbp
0000010F C3                 *   retn 

00000110                    *   .xdata segment
00000018 01120305           *   db 1t + (00h shl 3), 18t, 3t, 05h + (00h shl 4)
0000001C 12320E530B50       *   dw 03212h, 0530eh, 0500bh
00000022 0000               *   align 4
00000024                    *   .xdata ends
00000018                    *   .pdata segment
00000018 000000007000000018 *   dd imagerel main, imagerel main+070h, imagerel $xdatasym+018h
00000024                    *   .pdata ends
00000110                        main	endp


00000110                        start	proc

00000110 4883EC28           *   sub rsp, 8 + @ReservedStack
00000114 33C9                   	xor	ecx, ecx
00000116                        	invoke	GetModuleHandleA, rcx
                            *    externdef __imp_GetModuleHandleA: ptr proc
00000116 FF15 00000000r     *    call __imp_GetModuleHandleA
0000011C 488905 00000000r       	mov	hInstance, rax

00000123                        	invoke	GetCommandLineA
                            *    externdef __imp_GetCommandLineA: ptr proc
00000123 FF15 00000000r     *    call __imp_GetCommandLineA
00000129 488905 00000000r       	mov	CommandLine, rax

00000130                        	invoke	main, hInstance, rax
00000130 488B0D 00000000r   *    mov rcx, hInstance
00000137 488BD0             *    mov rdx, rax
0000013A E861FFFFFF         *    call main
0000013F                        	invoke	ExitProcess, eax
0000013F 8BC8               *    mov ecx, eax
                            *    externdef __imp_ExitProcess: ptr proc
00000141 FF15 00000000r     *    call __imp_ExitProcess

                                	ret
00000147 4883C428           *   add rsp, 8 + @ReservedStack
0000014B C3                 *   retn

0000014C                        start	endp

                                end	start
0000014C                    *   _TEXT ends


Macros:

                N a m e                 Type

@CatStr  . . . . . . . . . . . .        Func
@Environ . . . . . . . . . . . .        Func
@InStr . . . . . . . . . . . . .        Func
@SizeStr . . . . . . . . . . . .        Func
@SubStr  . . . . . . . . . . . .        Func
dllimp . . . . . . . . . . . . .        Proc


Structures and Unions:

                N a m e                 Size/Ofs   Type

DBG_API  . . . . . . . . . . . .              10
  OutputDebugStringA . . . . . .               0   pfn_OutputDebugString
  OutputDebugStringW . . . . . .               8   pfn_OutputDebugString


Types:

                N a m e                 Size    Attr

HINSTANCE  . . . . . . . . . . .           8  QWord
PCSTR  . . . . . . . . . . . . .           8  Near Ptr 
PCWSTR . . . . . . . . . . . . .           8  Near Ptr 
PSTR . . . . . . . . . . . . . .           8  Near Ptr 
UINT . . . . . . . . . . . . . .           4  DWord
fn_OutputDebugString . . . . . .           8  Proc L Near64 FASTCALL
pfn_OutputDebugString  . . . . .           8  Near Ptr 


Segments and Groups:

                N a m e                 Size     Length   Align   Combine Class

FLAT . . . . . . . . . . . . . .        GROUP
.pdata . . . . . . . . . . . . .        64 Bit   00000024 DWord   Private 'DATA'
.xdata . . . . . . . . . . . . .        64 Bit   00000024 QWord   Private 'DATA'
_BSS . . . . . . . . . . . . . .        64 Bit   00000210 Para    Public  'BSS'
_DATA  . . . . . . . . . . . . .        64 Bit   00000050 Para    Public  'DATA'
_TEXT  . . . . . . . . . . . . .        64 Bit   0000014C Para    Public  'CODE'


Procedures, parameters and locals:

                N a m e                 Type     Value    Segment  Length

ExitProcess  . . . . . . . . . .        P Near64 00000000 No Seg   00000000 *External (kernel32) FASTCALL
GetCommandLineA  . . . . . . . .        P Near64 00000000 No Seg   00000000 *External (kernel32) FASTCALL
GetModuleHandleA . . . . . . . .        P Near64 00000000 No Seg   00000000 *External (kernel32) FASTCALL
GetStartupInfoA  . . . . . . . .        P Near64 00000000 No Seg   00000000 *External (kernel32) FASTCALL
GetStartupInfoW  . . . . . . . .        P Near64 00000000 No Seg   00000000 *External (kernel32) FASTCALL
OutputDebugStringA . . . . . . .        P Near64 00000000 No Seg   00000000 *External (kernel32) FASTCALL
OutputDebugStringW . . . . . . .        P Near64 00000000 No Seg   00000000 *External (kernel32) FASTCALL
__getmainargs  . . . . . . . . .        P Near64 00000000 No Seg   00000000 *External (msvcrt.d) FASTCALL
asm_ver  . . . . . . . . . . . .        P Near   00000040 _TEXT    00000052 Public   FASTCALL
  version  . . . . . . . . . . .        DWord             rbp + 0010
main . . . . . . . . . . . . . .        P Near   000000A0 _TEXT    00000070 Public   FASTCALL
  CmdLine  . . . . . . . . . . .        Near              rbp + 0018
  hInst  . . . . . . . . . . . .        QWord             rbp + 0010
  @C0001 . . . . . . . . . . . .        L Near   00000108 _TEXT
  @C0002 . . . . . . . . . . . .        L Near   0000010A _TEXT
print  . . . . . . . . . . . . .        P Near   00000000 _TEXT    00000038 Public   FASTCALL
  msg  . . . . . . . . . . . . .        Near              rbp + 0010
  strLf  . . . . . . . . . . . .        QWord             rbp - 0010
printf . . . . . . . . . . . . .        P Near64 00000000 No Seg   00000000 *External (msvcrt.d) FASTCALL
sprintf  . . . . . . . . . . . .        P Near64 00000000 No Seg   00000000 *External (msvcrt.d) FASTCALL
start  . . . . . . . . . . . . .        P Near   00000110 _TEXT    0000003C Public   FASTCALL


Symbols:

                N a m e                 Type       Value     Attr

$xdatasym  . . . . . . . . . . .        L Near             0h .xdata FASTCALL
@CodeSize  . . . . . . . . . . .        Number             0h 
@DataSize  . . . . . . . . . . .        Number             0h 
@Interface . . . . . . . . . . .        Number             7h 
@Model . . . . . . . . . . . . .        Number             7h 
@ReservedStack . . . . . . . . .        Number            20h 
@code  . . . . . . . . . . . . .        Text   _TEXT
@data  . . . . . . . . . . . . .        Text   FLAT
@stack . . . . . . . . . . . . .        Text   FLAT
AppName  . . . . . . . . . . . .        Byte[17]           0h _DATA FASTCALL
AsmVersion . . . . . . . . . . .        DWord             1Eh _DATA Public FASTCALL
CommandLine  . . . . . . . . . .        PSTR               8h _BSS FASTCALL
DIRECT_IMPORTS . . . . . . . . .        Text   
DIRECT_IMPORTS_FIX . . . . . . .        Text   
DbgApi . . . . . . . . . . . . .        DBG_API           40h _DATA Public FASTCALL
EFRAME . . . . . . . . . . . . .        Text   export FRAME
GetCommandLine . . . . . . . . .        Text   GetCommandLineA
GetModuleHandle  . . . . . . . .        Text   GetModuleHandleA
GetStartupInfo . . . . . . . . .        Text   GetStartupInfoA
NULL . . . . . . . . . . . . . .        Number             0h 
OutputDebugString  . . . . . . .        Text   OutputDebugStringA
PE_IMP_REF . . . . . . . . . . .        Number             1h 
__imp_ExitProcess  . . . . . . .        Near               0h _TEXT External FASTCALL
__imp_GetCommandLineA  . . . . .        Near               0h _TEXT External FASTCALL
__imp_GetModuleHandleA . . . . .        Near               0h _TEXT External FASTCALL
__imp_OutputDebugStringA . . . .        Near               0h _DATA External FASTCALL
__imp_OutputDebugStringW . . . .        Near               0h _DATA External FASTCALL
__imp_printf . . . . . . . . . .        Near               0h _TEXT External FASTCALL
__imp_sprintf  . . . . . . . . .        Near               0h _TEXT External FASTCALL
div100 . . . . . . . . . . . . .        Number      A3D70A3Dh 
getmainargs  . . . . . . . . . .        Text   __getmainargs
hInstance  . . . . . . . . . . .        HINSTANCE          0h _BSS FASTCALL
strBuffer  . . . . . . . . . . .        Byte[512]         10h _BSS FASTCALL
szAsmVerFmt  . . . . . . . . . .        Byte[26]          22h _DATA FASTCALL
szFmt  . . . . . . . . . . . . .        Byte[13]          11h _DATA FASTCALL

test.pe.imports.ref.asm: 192 lines, 2 passes, 1 ms, 0 warnings, 0 errors
